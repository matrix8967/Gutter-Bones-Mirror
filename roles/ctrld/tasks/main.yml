---
  - name: Download ctrld installer script
    get_url:
      url: https://api.controld.com/dl
      dest: /usr/local/bin/ctrld_installer.sh
      mode: '0755'
  - name: Install ctrld
    command: /usr/local/bin/ctrld_installer.sh {{ resolver_id }} forced
    args:
      creates: /usr/local/bin/ctrld
  
  - name: Create ctrld configuration
    template:
      src: ctrld.toml.j2
      dest: /etc/controld/ctrld.toml
    notify:
      - restart ctrld

  - name: Enable and start systemd service
    ansible.builtin.service:
      name: ctrld
      enabled: yes
      state: started
    when: ctrld_manage_service | default(true)

  - name: Start ctrld without systemd (CI/non-systemd)
    command: /usr/local/bin/ctrld start
    changed_when: false
    when: not (ctrld_manage_service | default(true))
