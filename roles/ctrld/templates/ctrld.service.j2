[Unit]
Description=Control-D DNS Proxy
After=network.target network-online.target
Wants=network-online.target
Documentation=https://docs.controld.com/
{% if is_router | default(false) %}
After=router-ready.target
{% endif %}

[Service]
Type=simple
User={{ ctrld_service_user }}
Group={{ ctrld_service_user }}
ExecStart={{ ctrld_binary_path }} run --config {{ ctrld_config_file }}
ExecReload=/bin/kill -HUP $MAINPID
ExecStop={{ ctrld_binary_path }} stop
Restart=always
RestartSec=5
StartLimitInterval=60
StartLimitBurst=3

# Output to journal
StandardOutput=journal
StandardError=journal
SyslogIdentifier=ctrld

# Process management
KillMode=mixed
TimeoutStartSec=30
TimeoutStopSec=10
KillSignal=SIGTERM

# Security settings (only for non-router systems)
{% if not is_router | default(false) %}
NoNewPrivileges=yes
PrivateTmp=yes
ProtectSystem=strict
ProtectHome=yes
ReadWritePaths={{ ctrld_config_dir }} {{ ctrld_log_dir }}
CapabilityBoundingSet=CAP_NET_BIND_SERVICE CAP_NET_RAW
AmbientCapabilities=CAP_NET_BIND_SERVICE CAP_NET_RAW
{% endif %}

# Environment
Environment=CTRLD_CONFIG_PATH={{ ctrld_config_dir }}
Environment=CTRLD_LOG_LEVEL={{ ctrld_log_level | default('info') }}
{% if resolver_id is defined %}
Environment=CTRLD_RESOLVER_ID={{ resolver_id }}
{% endif %}

# Working directory
WorkingDirectory={{ ctrld_config_dir }}

# Logging
{% if ctrld_log_dir is defined %}
Environment=CTRLD_LOG_PATH={{ ctrld_log_dir }}/ctrld.log
{% endif %}

[Install]
WantedBy=multi-user.target
{% if is_router | default(false) %}
WantedBy=router.target
{% endif %}
