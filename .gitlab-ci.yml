update_scrolls_submodule:
  image: alpine:latest
  script:
    - apk add git openssh
    - git config --global user.email "ci-bot@gitlab.com"
    - git config --global user.name "GitLab CI Bot"
    - git submodule update --remote --merge
    - git add roles/scrolls
    - git commit -m "Auto-update scrolls submodule" || echo "No changes"
    - git push https://gitlab-ci-token:${CI_PUSH_TOKEN}@gitlab.com/matrix8967/gutter_bonez.git HEAD:main
  only:
    - main

lint:
  image: python:3.12-slim
  before_script:
    - apt-get update && apt-get install -y git && rm -rf /var/lib/apt/lists/*
    - git --version
    - git config --global --add safe.directory "$CI_PROJECT_DIR"
    - pip install --no-cache-dir ansible==9.7.0 ansible-core==2.16.8 ansible-lint==24.6.0 yamllint==1.35.1 pre-commit==3.7.1
  script:
    - pre-commit run --all-files
  only:
    - merge_requests
    - branches
  except:
    - main

molecule:
  image: docker:27
  services:
    - docker:27-dind
  variables:
    DOCKER_DRIVER: overlay2
    DOCKER_TLS_CERTDIR: ""
    DOCKER_HOST: tcp://docker:2375
  before_script:
    - apk add --no-cache python3 py3-pip git
    - pip install --break-system-packages molecule==24.6.0 "molecule-plugins[docker]==23.5.3" ansible==9.7.0 ansible-core==2.16.8 pytest==8.3.2 testinfra==10.1.0 ansible-lint==24.6.0
  script:
    - docker info
    - molecule test -s default
    - molecule test -s ctrld
  rules:
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
    - if: $CI_COMMIT_BRANCH && $CI_COMMIT_BRANCH != 'main'

